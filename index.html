<!DOCTYPE html>  
<html lang="tr">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1">  
  <title>Su Tesisleri Dairesi Başkanlığı Piezometre Hesaplama Tablosu</title>  
  <style>  
    html, body {  
        
    }  
    body {  
      font-family: sans-serif;  
      padding: 1rem;  
      max-width: 1000px;
      margin: auto;  
    }  
    h2 {
      text-align: center;
      color: #8B0000;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      word-wrap: break-word;
      white-space: normal;
      overflow-wrap: break-word;
    }
    th {
      background-color: #f4f4f4;
      font-size: 12px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      margin: 5px 0;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 11px;
    }
    button {
      padding: 8px 12px;
      margin-right: 5px;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #008CBA;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #006F8E;
    }
    select.boru,
    select.atu {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: none;
      width: 100%;
      max-width: 250px;
      padding: 6px;
      margin: 5px 0;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 12px;
    }
    .output {
      background: #f9f9f9;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    th, td {  
      width: 16%;  
    }  
    @media (max-width: 768px) {  
      table {  
        display: block;  
        overflow-x: auto;  
        white-space: nowrap;  
      }  
    }
    
    /* Boru Çapı/Debi Tablosu için özel stil */
    .boru-debi-tablosu {
      font-size: 11px;
    }
    .boru-debi-tablosu th, 
    .boru-debi-tablosu td {
      padding: 4px;
      font-size: 11px;
    }
    
    /* Grafik konteyner stili - YÜKSEKLİK ARTIRILDI */
    .grafik-container {
      margin-top: 10px;
      width: 100%;
      height: 600px; /* 400px'den 600px'ye çıkarıldı */
      min-height: 600px;
    }
    
    /* Buton grubu stili */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    /* Uyarı renkleri */
    .vantuz {
      background-color: #FFD700 !important;
    }
    .tahliye {
      background-color: #87CEEB !important;
    }
    .dusuk-basinc {
      background-color: #FFA07A !important;
    }
  </style>  
</head>  
<body>  
  <h2>Su Tesisleri Dairesi Başkanlığı Piezometre Hesaplama Tablosu</h2>  
  
  <table>  
    <thead>  
      <tr>  
        <th>Debi (L/s)</th>  
        <th>Kot (m)</th>  
        <th>Mesafe (m)</th>  
        <th>Boru Çapı (mm)</th>  
        <th>Atü (bar)</th>  
        <th>Hız (m/s)</th>
        <th>İşletme Basıncı (m)</th>  
      </tr>  
    </thead>  
    <tbody id="noktalarTablo">  
    </tbody>  
  </table>  

  <div class="button-group">
    <button onclick="ekleNokta()">Nokta Ekle</button>
    <button onclick="hesapla()">Hesapla</button>
    <button onclick="exceleKaydet()">Excel'e Kaydet</button>
    <button onclick="grafikGoster()">Grafik Göster</button>
  </div>

  <div class="grafik-container">
    <canvas id="basincGrafik"></canvas>
  </div>
  
  <div>
    <h3>Boru Çapı / Debi / Ağırlık Tablosu</h3>
    <table class="boru-debi-tablosu">
      <thead>
        <tr>
          <th>Boru Çapı / Atü</th>
          <th>0,8 m/s Debi (l/s)</th>
          <th>1,0 m/s Debi (l/s)</th>
          <th>1,2 m/s Debi (l/s)</th>
          <th>Ağırlık (kg/m)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Boru çapı tablosu verileri burada -->
      </tbody>
    </table>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>  
    const boruTablosu = {
      "32": { "10": 28, "16": 26 },
      "40": { "10": 35.2, "16": 32.6 },
      "50": { "10": 44, "16": 40.8 },
      "63": { "10": 55.4, "16": 51.4 },
      "75": { "10": 66, "16": 61.4 },
      "90": { "10": 79.2, "16": 73.6 },
      "110": { "10": 96.8, "16": 90 },
      "125": { "10": 110.2, "16": 102.2 },
      "140": { "10": 123.4, "16": 114.6 },
      "160": { "10": 141, "16": 130.8 },
      "180": { "10": 158.6, "16": 147.2 },
      "200": { "10": 176.2, "16": 163.6 },
      "225": { "10": 198.2, "16": 184 },
      "250": { "10": 220.4, "16": 204.6 },
      "280": { "10": 246.8, "16": 229.2 },
      "315": { "10": 277.6, "16": 257.8 },
      "355": { "10": 312.8, "16": 290.6 },
      "400": { "10": 352.6, "16": 327.4 },
      "450": { "10": 396.6, "16": 368.2 }
    };

    let basincGrafik = null;
    const grafikData = {
      mesafeler: [],
      kotDegerleri: [],
      piezoKotlari: [],
      uyarilar: []
    };

    function ekleNokta() {  
      const tbody = document.getElementById('noktalarTablo');  
      const row = document.createElement('tr');  
      const boruOnceki = tbody.children.length > 0 ? tbody.children[tbody.children.length - 1].querySelector('.boru').value : '110';  
      const atuOnceki = tbody.children.length > 0 ? tbody.children[tbody.children.length - 1].querySelector('.atu').value : '10';  
      const debiOnceki = tbody.children.length > 0 ? tbody.children[tbody.children.length - 1].querySelector('.debi').value : '';  
  
      row.innerHTML = `  
        <td><input type="number" class="debi" value="${debiOnceki}" placeholder="debi" /></td>  
        <td><input type="number" class="kot" placeholder="kot" /></td>  
        <td><input type="number" class="mesafe" placeholder="mesafe" value="${tbody.children.length === 0 ? 0 : ''}" ${tbody.children.length === 0 ? 'readonly' : ''} /></td>  
        <td><select class="boru">  
          ${Object.keys(boruTablosu).map(c => `<option value="${c}" ${boruOnceki === c ? 'selected' : ''}>${c}</option>`).join('')}  
        </select></td>  
        <td><select class="atu">  
          <option value="10" ${atuOnceki === '10' ? 'selected' : ''}>10</option>  
          <option value="16" ${atuOnceki === '16' ? 'selected' : ''}>16</option>  
        </select></td>  
        <td><input type="number" class="hiz" readonly /></td>  
        <td><input type="number" class="isletme" readonly /></td>  
      `;  
      tbody.appendChild(row);  
    }  

    function hesapla() {  
      const rows = document.querySelectorAll("#noktalarTablo tr");  
      let toplamYukKaybi = 0;  
      const ilkKot = parseFloat(rows[0].querySelector(".kot").value) || 0;  
      let kumulatifMesafe = 0;
      
      grafikData.mesafeler = [];
      grafikData.kotDegerleri = [];
      grafikData.piezoKotlari = [];
      grafikData.uyarilar = [];
  
      rows.forEach((row, i) => {  
        const kot = parseFloat(row.querySelector(".kot").value) || 0;  
        const mesafe = parseFloat(row.querySelector(".mesafe").value) || 0;  
        kumulatifMesafe += mesafe;
        const cap = row.querySelector(".boru").value;  
        const atu = row.querySelector(".atu").value;  
        const debi = parseFloat(row.querySelector(".debi").value) || 0;  
  
        const icCap = boruTablosu[cap][atu];  
        if (!icCap) {  
          alert(`İç çap bulunamadı: ${cap} - ${atu}`);  
          return;  
        }  
  
        const icCapM = icCap / 1000;  
        const alan = Math.PI * Math.pow(icCapM / 2, 2);  
        const hiz = debi / 1000 / alan;  
  
        const yukKaybi = 6.815 * Math.pow(hiz / 150, 1.852) * Math.pow(icCapM, -1.167) * mesafe;  
        toplamYukKaybi += yukKaybi;  
        const piezoKot = ilkKot - toplamYukKaybi;  
        const isletmeBasinci = piezoKot - kot;
        
        row.querySelector(".hiz").value = hiz.toFixed(2);  
        row.querySelector(".isletme").value = isletmeBasinci.toFixed(2);  
        
        let uyarı = "";
        row.className = "";
        
        if (i > 0) {
          const prevKot = parseFloat(rows[i - 1].querySelector(".kot").value) || 0;
          const nextKot = parseFloat(rows[i + 1]?.querySelector(".kot")?.value) || null;

          if (nextKot !== null) {
            if (kot > prevKot && kot > nextKot) {
              uyarı = "Vantuz";
              row.classList.add("vantuz");
            }
            if (kot < prevKot && kot < nextKot) {
              uyarı = "Tahliye";
              row.classList.add("tahliye");
            }
          }
        }

        if (isletmeBasinci < 2) {
          uyarı = "Düşük Basınç";
          row.classList.add("dusuk-basinc");
        }

        grafikData.mesafeler.push(parseFloat(kumulatifMesafe.toFixed(2)));
        grafikData.kotDegerleri.push(parseFloat(kot.toFixed(2)));
        grafikData.piezoKotlari.push(parseFloat(piezoKot.toFixed(2)));
        grafikData.uyarilar.push(uyarı);
      });  
      
      grafikGoster();
    }

    function grafikGoster() {
      const ctx = document.getElementById('basincGrafik').getContext('2d');
      
      if (basincGrafik) {
        basincGrafik.destroy();
      }
      
      // Kot değerlerinden min ve max değerleri bul
      const minKot = Math.min(...grafikData.kotDegerleri);
      const maxKot = Math.max(...grafikData.kotDegerleri);
      const minPiezo = Math.min(...grafikData.piezoKotlari);
      const maxPiezo = Math.max(...grafikData.piezoKotlari);
      
      // Tüm değerler için genel min ve max bul
      const genelMin = Math.min(minKot, minPiezo);
      const genelMax = Math.max(maxKot, maxPiezo);
      
      // Y ekseni aralığını belirle (daha fazla marj ekleyerek)
      const aralik = genelMax - genelMin;
      const yMin = genelMin - aralik * 0.5; // %50 marj
      const yMax = genelMax + aralik * 0.5; // %50 marj
      
      // Adım boyutunu belirle
      const stepSize = Math.max(5, Math.round(aralik / 8));
      
      basincGrafik = new Chart(ctx, {
        type: 'line',
        data: {
          labels: grafikData.mesafeler.map(m => m.toString()),
          datasets: [
            {
              label: 'Kot (m)',
              data: grafikData.kotDegerleri,
              borderColor: 'rgb(54, 162, 235)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderWidth: 2,
              tension: 0.1,
              pointBackgroundColor: grafikData.uyarilar.map(uyari => {
                if (uyari === "Vantuz") return 'rgba(255, 215, 0, 0.7)';
                if (uyari === "Tahliye") return 'rgba(135, 206, 235, 0.7)';
                if (uyari === "Düşük Basınç") return 'rgba(255, 160, 122, 0.7)';
                return 'rgba(54, 162, 235, 0.7)';
              }),
              pointRadius: 6,
              pointHoverRadius: 8
            },
            {
              label: 'Piezometre Kotu (m)',
              data: grafikData.piezoKotlari,
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderWidth: 2,
              tension: 0.1,
              borderDash: [5, 5],
              pointRadius: 6,
              pointHoverRadius: 8
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // En-boy oranını koruma özelliğini kapat
          plugins: {
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  return grafikData.uyarilar[index] ? 'Uyarı: ' + grafikData.uyarilar[index] : '';
                }
              }
            },
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Kümülatif Mesafeye Göre Kot ve Piezometre Hattı',
              font: {
                size: 16
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              min: yMin,
              max: yMax,
              title: {
                display: true,
                text: 'Kot (m)'
              },
              ticks: {
                stepSize: stepSize
              },
              grid: {
                drawOnChartArea: true,
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Kümülatif Mesafe (m)'
              },
              grid: {
                drawOnChartArea: true,
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          layout: {
            padding: {
              top: 20,
              right: 20,
              bottom: 20,
              left: 20
            }
          }
        }
      });
    }

    function exceleKaydet() {
      const rows = document.querySelectorAll("#noktalarTablo tr");
      const ilkKot = parseFloat(rows[0]?.querySelector(".kot").value) || 0;
      let toplamYukKaybi = 0;
      let kumulatifMesafe = 0;
      const data = [["Debi (L/s)", "Kot (m)", "Mesafe (m)", "Kümülatif Mesafe (m)", "Yük Kaybı (m)", "Toplam Yük Kaybı (m)", "Boru Çapı (mm)", "Atü (bar)", "Hız (m/s)", "İşletme Basıncı (m)", "Koç Darbesi", "Boru Basıncı (m)", "Uyarı"]];
      
      rows.forEach((row, i) => {
        const debi = parseFloat(row.querySelector(".debi").value) || 0;
        const kot = parseFloat(row.querySelector(".kot").value) || 0;
        const mesafe = parseFloat(row.querySelector(".mesafe").value) || 0;
        kumulatifMesafe += mesafe;
        const cap = row.querySelector(".boru").value;
        const atu = row.querySelector(".atu").value;
        const icCap = boruTablosu[cap][atu] / 1000;
        const alan = Math.PI * Math.pow(icCap / 2, 2);
        const hiz = debi / 1000 / alan;
        const yukKaybi = 6.815 * Math.pow(hiz / 150, 1.852) * Math.pow(icCap, -1.167) * mesafe;
        toplamYukKaybi += yukKaybi;
        const piezoKot = ilkKot - toplamYukKaybi;
        const isletme = piezoKot - kot;
        const boruCap = parseFloat(cap);
        const kocDarbesi = Math.sqrt((2100 * 1000) / (1 + 2.1 * ((icCap * 1000) / ((boruCap - (icCap * 1000)) / 2)))) * (hiz / (9.82 * 2)); 
        const boruBasinci = ilkKot - kot + kocDarbesi;

        let uyarı = "";
        if (i > 0) {
          const prevKot = parseFloat(rows[i - 1].querySelector(".kot").value) || 0;
          const nextKot = parseFloat(rows[i + 1]?.querySelector(".kot")?.value) || null;

          if (nextKot !== null) {
            if (kot > prevKot && kot > nextKot) uyarı = "Vantuz";
            if (kot < prevKot && kot < nextKot) uyarı = "Tahliye";
          }
        }

        if (isletme < 2) {
          uyarı = "Düşük Basınç";
        }

        data.push([
          debi, 
          kot, 
          mesafe,
          kumulatifMesafe.toFixed(2),
          yukKaybi.toFixed(2),
          toplamYukKaybi.toFixed(2),
          cap, 
          atu,
          hiz.toFixed(2), 
          isletme.toFixed(2), 
          kocDarbesi.toFixed(2), 
          boruBasinci.toFixed(2), 
          uyarı
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      
      const headerStyle = {
        font: { bold: true, color: { rgb: 'FFFFFF' } },
        alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
        fill: { fgColor: { rgb: '4F81BD' } },
        border: {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        }
      };

      const rowStyle = {
        alignment: { horizontal: 'center', vertical: 'center' },
        border: {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        }
      };

      XLSX.utils.sheet_add_aoa(ws, [data[0]], { origin: "A1" });
      ws['A1'].s = headerStyle;

      for (let i = 1; i < data.length; i++) {
        XLSX.utils.sheet_add_aoa(ws, [data[i]], { origin: `A${i + 1}` });
        const row = ws[`A${i + 1}`];
        row.s = rowStyle;

        if (data[i][12] === "Vantuz") {
          ws[`A${i + 1}`].s.fill = { fgColor: { rgb: "FFD700" } };
        } else if (data[i][12] === "Tahliye") {
          ws[`A${i + 1}`].s.fill = { fgColor: { rgb: "87CEEB" } };
        } else if (data[i][12] === "Düşük Basınç") {
          ws[`A${i + 1}`].s.fill = { fgColor: { rgb: "FFA07A" } };
        }
      }

      ws['!cols'] = [
        { wch: 10 }, { wch: 10 }, { wch: 12 }, 
        { wch: 12 }, { wch: 12 }, { wch: 12 },
        { wch: 10 }, { wch: 10 }, { wch: 12 },
        { wch: 12 }, { wch: 12 }, { wch: 15 }
      ];

      ws['!rows'] = ws['!rows'] || [];
      ws['!rows'][0] = { hpt: 30 };

      XLSX.utils.book_append_sheet(wb, ws, "Piezometre Hesabı");
      XLSX.writeFile(wb, "piezometre_hesabi.xlsx");
    }

    window.onload = function() {
      ekleNokta();
    };
  </script>  
</body>  
</html>